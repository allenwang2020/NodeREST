# circle.yml  
machine:    
# 安裝 eb 需要 python    
    python:      
       version: 2.7.9 
# 環境改成 docker    
    services:      
       - docker    
    post:
       - sudo service mongodb stop   
dependencies:  
   pre:
    # 安裝 eb
   - pip install --upgrade pip
   - pip install awsebcli
   - eb init -p docker
   override:      
# 建構方式使用 docker build      
   #-  docker info
   #- docker build -t node-web -f Dockerfile.web . 
   #- docker build -t node-mongodb -f Dockerfile.mongodb .  
   - docker-compose up -d
   - docker ps
   - env | grep DOCKER
         
test:    
    override:      
        - npm test
        #- ./node_modules/.bin/mocha      
        # 使用 curl 測試 docker 是否有順利執行 node   
        #- docker run -d -p 3000:3000 hello-ci-workflow; sleep 10
        - curl --retry 10 --retry-delay 5 -v http://localhost:80
# 新增一筆部署腳本production  
deployment:    
   development:
    branch: develop 
    commands:
     - eb deploy NodeREST-env-dev  
   production:      
    branch: master      
    commands:
     - eb deploy NodeREST-env-prod  